<%- include('partials/header', { title: 'Finaliser ma commande - Mansa', user: user }) %>

<section class="py-8 min-h-screen bg-gray-100">
    <div class="container mx-auto px-4">
        <!-- Breadcrumb -->
        <nav class="flex mb-8" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
                <li class="inline-flex items-center">
                    <a href="/" class="text-gray-700 hover:text-bogolan">
                        <i class="fas fa-home"></i>
                    </a>
                </li>
                <li>
                    <div class="flex items-center">
                        <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                        <a href="/panier" class="text-gray-700 hover:text-bogolan">Panier</a>
                    </div>
                </li>
                <li>
                    <div class="flex items-center">
                        <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                        <span class="text-gray-500">Commande</span>
                    </div>
                </li>
            </ol>
        </nav>

        <div class="max-w-6xl mx-auto">
            <h1 class="text-3xl font-bold text-bogolan mb-8">Finaliser ma commande</h1>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Formulaire de commande -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold mb-6 text-bogolan">Informations de livraison</h2>

                    <form id="order-form">
                        <!-- Informations personnelles -->
                        <div class="mb-6">
                            <h3 class="font-semibold mb-4">Vos informations</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Prénom*</label>
                                    <input type="text" name="prenom" required 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-bogolan"
                                           value="<%= user ? user.prenom : '' %>">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nom*</label>
                                    <input type="text" name="nom" required 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-bogolan"
                                           value="<%= user ? user.nom : '' %>">
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Téléphone*</label>
                                <input type="tel" name="telephone" required 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-bogolan"
                                       value="<%= user ? user.telephone : '' %>">
                            </div>
                        </div>

                        <!-- Adresse de livraison -->
                        <div class="mb-6">
                            <h3 class="font-semibold mb-4">Adresse de livraison</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Adresse ligne 1*</label>
                                    <input type="text" name="adresse_ligne1" required 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-bogolan"
                                           value="<%= user ? user.adresse_ligne1 || '' : '' %>">
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Ville*</label>
                                        <input type="text" name="ville" required 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-bogolan"
                                               value="<%= user ? user.ville || '' : '' %>">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Code postal*</label>
                                        <input type="text" name="code_postal" required 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-bogolan"
                                               value="<%= user ? user.code_postal || '' : '' %>">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Pays*</label>
                                    <select name="pays" required 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-bogolan">
                                        <option value="France" <%= (user && user.pays === 'Paris') ? 'selected' : '' %>>Paris</option>
                                        <option value="Belgique">Bamako</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Mode de paiement -->
                        <div class="mb-6">
                            <h3 class="font-semibold mb-4">Mode de paiement</h3>
                            <div class="space-y-3">
                                <div class="flex items-center">
                                    <input type="radio" name="mode_paiement" value="carte" id="carte" checked
                                           class="h-4 w-4 text-bogolan focus:ring-bogolan border-gray-300">
                                    <label for="carte" class="ml-3 text-sm font-medium text-gray-700">
                                        <i class="fas fa-credit-card mr-2"></i>Carte bancaire (simulé)
                                    </label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" name="mode_paiement" value="paypal" id="paypal"
                                           class="h-4 w-4 text-bogolan focus:ring-bogolan border-gray-300">
                                    <label for="paypal" class="ml-3 text-sm font-medium text-gray-700">
                                        <i class="fab fa-paypal mr-2"></i>PayPal (simulé)
                                    </label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" name="mode_paiement" value="virement" id="virement"
                                           class="h-4 w-4 text-bogolan focus:ring-bogolan border-gray-300">
                                    <label for="virement" class="ml-3 text-sm font-medium text-gray-700">
                                        <i class="fas fa-university mr-2"></i>Virement bancaire
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Instructions spéciales</label>
                            <textarea name="notes_client" rows="3" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-bogolan"
                                      placeholder="Instructions de livraison, commentaires..."></textarea>
                        </div>
                    </form>
                </div>

                <!-- Résumé de la commande -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold mb-6 text-bogolan">Récapitulatif</h2>

                    <div id="order-summary">
                        <!-- Loading -->
                        <div id="summary-loading" class="text-center py-8">
                            <i class="fas fa-spinner fa-spin text-2xl text-bogolan"></i>
                            <p class="text-gray-600 mt-2">Chargement...</p>
                        </div>
                    </div>

                    <!-- Totaux -->
                    <div id="order-totals" class="hidden border-t pt-4 mt-6">
                        <div class="space-y-2 mb-4">
                            <div class="flex justify-between">
                                <span>Sous-total</span>
                                <span id="summary-subtotal">0,00 €</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Livraison</span>
                                <span id="summary-shipping">0,00 €</span>
                            </div>
                            <div class="border-t pt-2 mt-2">
                                <div class="flex justify-between font-bold text-lg">
                                    <span>Total</span>
                                    <span id="summary-total">0,00 €</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                            <p class="text-sm text-blue-800">
                                <i class="fas fa-info-circle mr-2"></i>
                                <strong>Mode test :</strong> Aucun paiement ne sera effectué. Votre commande sera automatiquement confirmée.
                            </p>
                        </div>

                        <button 
                            id="confirm-order-btn" 
                            class="w-full bg-bogolan text-white py-3 px-4 rounded-lg font-semibold hover:bg-bogolan-light transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled
                        >
                            <i class="fas fa-check mr-2"></i>
                            Confirmer la commande
                        </button>

                        <p class="text-xs text-gray-500 mt-3 text-center">
                            En confirmant, vous acceptez nos conditions générales de vente
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
let cartData = { items: [], total: 0, nombre_articles: 0 };

// Load cart summary on page load
document.addEventListener('DOMContentLoaded', function() {
    loadCartSummary();
});

// Load cart summary
async function loadCartSummary() {
    try {
        const response = await fetch('/api/panier');
        const data = await response.json();
        
        if (data.success && data.items.length > 0) {
            cartData = data;
            displayOrderSummary();
        } else {
            // Redirect to cart if empty
            window.location.href = '/panier';
        }
    } catch (error) {
        console.error('Erreur chargement panier:', error);
        window.location.href = '/panier';
    }
}

// Display order summary
function displayOrderSummary() {
    const summaryContainer = document.getElementById('order-summary');
    const loadingElement = document.getElementById('summary-loading');
    const totalsElement = document.getElementById('order-totals');
    
    loadingElement.classList.add('hidden');
    
    // Display items
    summaryContainer.innerHTML = cartData.items.map(item => `
        <div class="flex items-center space-x-4 py-3 border-b border-gray-200">
            <div class="w-16 h-16 bg-gray-200 rounded-lg flex-shrink-0">
                ${item.images ? `<img src="/uploads/products/${JSON.parse(item.images).principale}" alt="${item.nom}" class="w-full h-full object-cover rounded-lg">` : ''}
            </div>
            <div class="flex-1">
                <h4 class="font-medium">${item.nom}</h4>
                <p class="text-sm text-gray-600">${item.taille} - ${item.couleur}</p>
                <p class="text-sm">Quantité: ${item.quantite}</p>
            </div>
            <div class="text-right">
                <p class="font-semibold">${(parseFloat(item.prix_vente) * item.quantite).toFixed(2)} €</p>
            </div>
        </div>
    `).join('');
    
    // Calculate totals
    const subtotal = cartData.total;
    const shipping = subtotal >= 150 ? 0 : 9.90;
    const total = subtotal + shipping;
    
    // Update totals
    document.getElementById('summary-subtotal').textContent = `${subtotal.toFixed(2)} €`;
    document.getElementById('summary-shipping').textContent = shipping === 0 ? 'Gratuite' : `${shipping.toFixed(2)} €`;
    document.getElementById('summary-total').textContent = `${total.toFixed(2)} €`;
    
    // Show totals and enable button
    totalsElement.classList.remove('hidden');
    document.getElementById('confirm-order-btn').disabled = false;
}

// Confirm order
document.getElementById('confirm-order-btn').addEventListener('click', async function() {
    const form = document.getElementById('order-form');
    const formData = new FormData(form);
    
    // Validate form
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Disable button during processing
    this.disabled = true;
    this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Traitement en cours...';
    
    try {
        // Prepare order data
        const orderData = {
            adresse_livraison: {
                prenom: formData.get('prenom'),
                nom: formData.get('nom'),
                telephone: formData.get('telephone'),
                adresse_ligne1: formData.get('adresse_ligne1'),
                adresse_ligne2: formData.get('adresse_ligne2'),
                ville: formData.get('ville'),
                code_postal: formData.get('code_postal'),
                pays: formData.get('pays')
            },
            mode_paiement: formData.get('mode_paiement'),
            notes_client: formData.get('notes_client')
        };
        
        const response = await fetch('/api/commande/finaliser', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(orderData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Redirect to success page
            window.location.href = `/commande/confirmation/${data.numero_commande}`;
        } else {
            throw new Error(data.message || 'Erreur lors de la création de la commande');
        }
        
    } catch (error) {
        console.error('Erreur création commande:', error);
        showNotification(error.message || 'Erreur lors de la création de la commande', 'error');
        
        // Re-enable button
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-check mr-2"></i>Confirmer la commande';
    }
});

// Simple notification function
function showNotification(message, type) {
    const notification = document.createElement('div');
    const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500'
    };
    
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg ${colors[type]} text-white max-w-sm`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}
</script>

<%- include('partials/footer') %>
